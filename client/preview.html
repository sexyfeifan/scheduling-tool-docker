<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½å¤´åœºé€šå‘Šæ’æœŸ</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* é¢„è§ˆé¡µé¢ç‰¹æ®Šæ ·å¼ */
        .preview-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .preview-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .preview-toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .preview-toolbar .btn {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .preview-toolbar .btn.primary {
            background-color: #bdc3c7;
        }
        
        .preview-toolbar .btn.secondary {
            background-color: #bdc3c7;
        }
        
        /* éšè—ç¼–è¾‘ç›¸å…³å…ƒç´  */
        .project-card:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .delete-btn {
            display: none;
        }
        
        .project-card {
            cursor: default;
        }
        
        /* å®æ—¶æ›´æ–°æç¤º */
        .realtime-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #2ecc71;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }
        
        /* å¡ç‰‡æ“ä½œæŒ‰é’® */
        .card-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }
        
        .copy-btn {
            background-color: #bdc3c7;
            color: #7f8c8d;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: not-allowed;
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¢„è§ˆå¤´éƒ¨ -->
        <div class="preview-header">
            <h1>ç½å¤´åœºé€šå‘Šæ’æœŸ</h1>
            <p>åªè¯»æ¨¡å¼ - æ•°æ®å®æ—¶åŒæ­¥</p>
            <div class="preview-toolbar">
                <button id="prev-week" class="btn">â—€ ä¸Šå‘¨</button>
                <button id="current-week" class="btn primary">æœ¬å‘¨</button>
                <button id="next-week" class="btn">ä¸‹å‘¨ â–¶</button>
                <span id="week-display" class="week-display"></span>
                <button id="export-image" class="btn secondary">å¯¼å‡ºå›¾ç‰‡</button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æ˜ŸæœŸæ ‡é¢˜ -->
            <div class="week-header">
                <div class="day-header" id="monday-header">å‘¨ä¸€</div>
                <div class="day-header" id="tuesday-header">å‘¨äºŒ</div>
                <div class="day-header" id="wednesday-header">å‘¨ä¸‰</div>
                <div class="day-header" id="thursday-header">å‘¨å››</div>
                <div class="day-header" id="friday-header">å‘¨äº”</div>
                <div class="day-header" id="saturday-header">å‘¨å…­</div>
                <div class="day-header" id="sunday-header">å‘¨æ—¥</div>
            </div>

            <!-- é¡¹ç›®åˆ—è¡¨åŒºåŸŸ -->
            <div class="schedule-container">
                <div class="day-column" id="monday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="tuesday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="wednesday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="thursday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="friday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="saturday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
                <div class="day-column" id="sunday">
                    <div class="empty-state">ğŸˆšï¸</div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- å®æ—¶æ›´æ–°æç¤º -->
    <div id="realtime-indicator" class="realtime-indicator">æ•°æ®å·²æ›´æ–°</div>
    
    <!-- å›¾ç‰‡å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div id="export-modal" class="modal">
        <div class="modal-content export-modal">
            <span class="close" id="close-export">&times;</span>
            <h2>å¯¼å‡ºå›¾ç‰‡</h2>
            <div class="export-preview">
                <canvas id="export-canvas" style="width: 100%; max-width: 600px; border: 1px solid #ddd;"></canvas>
            </div>
            <div class="form-actions">
                <button id="download-image" class="btn primary">ä¸‹è½½å›¾ç‰‡</button>
                <button id="open-in-new-tab" class="btn">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</button>
                <button id="cancel-export" class="btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // è·å–å½“å‰å‘¨çš„å‘¨ä¸€æ—¥æœŸ
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´ï¼šå‘¨æ—¥ä¸ºç¬¬ä¸€å¤©æ—¶è°ƒæ•´ä¸ºå‘¨ä¸€
            return new Date(d.setDate(diff));
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º MMæœˆDDæ—¥
        function formatMonthDay(date) {
            return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }

        // è·å–ä¸€å‘¨çš„æ—¥æœŸ
        function getWeekDates(monday) {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        // å½“å‰å‘¨çš„å‘¨ä¸€
        let currentMonday = getMonday(new Date());

        // é¡¹ç›®æ•°æ®å­˜å‚¨
        let scheduleData = {};

        // DOMå…ƒç´ 
        const weekDisplay = document.getElementById('week-display');
        const prevWeekBtn = document.getElementById('prev-week');
        const nextWeekBtn = document.getElementById('next-week');
        const currentWeekBtn = document.getElementById('current-week');
        const exportImageBtn = document.getElementById('export-image');
        
        // å›¾ç‰‡å¯¼å‡ºå…ƒç´ 
        const exportModal = document.getElementById('export-modal');
        const closeExportBtn = document.getElementById('close-export');
        const exportCanvas = document.getElementById('export-canvas');
        const downloadImageBtn = document.getElementById('download-image');
        const openInNewTabBtn = document.getElementById('open-in-new-tab');
        const cancelExportBtn = document.getElementById('cancel-export');

        // APIè¯·æ±‚å°è£…
        const apiRequest = async (url, options = {}) => {
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
                ...options,
            };
            
            const response = await fetch(`/api${url}`, config);
            return response;
        };


        // æ›´æ–°å‘¨æ˜¾ç¤º
        function updateWeekDisplay() {
            const weekDates = getWeekDates(currentMonday);
            const startDate = formatMonthDay(weekDates[0]);
            const endDate = formatMonthDay(weekDates[6]);
            weekDisplay.textContent = `${startDate} - ${endDate}`;
        }

        // æ¸²æŸ“æ’æœŸè¡¨
        function renderSchedule() {
            const weekDates = getWeekDates(currentMonday);
            const dayColumns = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayHeaders = ['monday-header', 'tuesday-header', 'wednesday-header', 'thursday-header', 'friday-header', 'saturday-header', 'sunday-header'];
            
            // æ›´æ–°æ˜ŸæœŸæ ‡é¢˜ï¼Œæ˜¾ç¤ºå‡†ç¡®æ—¥æœŸ
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            dayHeaders.forEach((headerId, index) => {
                const header = document.getElementById(headerId);
                const date = weekDates[index];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                header.textContent = `${weekdays[index]} (${month}/${day})`;
            });
            
            dayColumns.forEach((columnId, index) => {
                const column = document.getElementById(columnId);
                const dateStr = formatDate(weekDates[index]);
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                column.innerHTML = '';
                
                // å¦‚æœæœ‰è¯¥é¡¹ç›®æ—¥æœŸçš„æ•°æ®ï¼Œåˆ™æ¸²æŸ“é¡¹ç›®å¡ç‰‡
                if (scheduleData[dateStr]) {
                    scheduleData[dateStr].forEach((project, projectIndex) => {
                        const projectCard = createProjectCard(project, dateStr, projectIndex);
                        column.appendChild(projectCard);
                    });
                } else {
                    // æ˜¾ç¤ºç©ºçŠ¶æ€
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = 'ğŸˆšï¸';
                    column.appendChild(emptyState);
                }
            });
        }

        // åˆ›å»ºé¡¹ç›®å¡ç‰‡
        function createProjectCard(project, dateStr, projectIndex) {
            const card = document.createElement('div');
            card.className = `project-card`;
            
            const typeClassMap = {
                'å¹³é¢': 'plane',
                'è§†é¢‘': 'video',
                'ç›´æ’­': 'live',
                'è¯•åš': 'test'
            };
            
            const typeClass = typeClassMap[project.type] || 'plane';
            
            // æ„å»ºå·¥ä½œäººå‘˜ä¿¡æ¯
            let staffInfo = '';
            if (project.director || project.photographer || project.production || project.rd || project.startTime) {
                staffInfo = '<div class="staff-info">';
                if (project.startTime) {
                    staffInfo += `<span class="staff-role start-time">â° ${project.startTime}</span>`;
                }
                if (project.director) {
                    staffInfo += `<span class="staff-role director">å¯¼æ¼”ï¼š${project.director}</span>`;
                }
                if (project.photographer) {
                    staffInfo += `<span class="staff-role photographer">æ‘„å½±ï¼š${project.photographer}</span>`;
                }
                if (project.production) {
                    staffInfo += `<span class="staff-role production">åˆ¶ç‰‡ï¼š${project.production}</span>`;
                }
                if (project.rd) {
                    staffInfo += `<span class="staff-role rd">ç ”å‘ï¼š${project.rd}</span>`;
                }
                staffInfo += '</div>';
            }
            
            // æ·»åŠ è€åˆ€å‡ºé•œæ ‡è®°
            const laodaoMark = project.laodao ? '<div class="laodao-mark">è€åˆ€å‡ºé•œ</div>' : '';
            
            card.innerHTML = `
                <div class="project-title">
                    <span>${project.name}</span>
                </div>
                ${laodaoMark}
                ${staffInfo}
                <div class="project-location">ğŸ“ ${project.location}</div>
                <div>
                    <span class="project-type ${typeClass}">${project.type}</span>
                </div>
            `;
            
            return card;
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘¨åˆ‡æ¢æŒ‰é’®
            prevWeekBtn.addEventListener('click', () => {
                currentMonday.setDate(currentMonday.getDate() - 7);
                updateWeekDisplay();
                renderSchedule();
            });
            
            nextWeekBtn.addEventListener('click', () => {
                currentMonday.setDate(currentMonday.getDate() + 7);
                updateWeekDisplay();
                renderSchedule();
            });
            
            currentWeekBtn.addEventListener('click', () => {
                currentMonday = getMonday(new Date());
                updateWeekDisplay();
                renderSchedule();
            });
            
            // å¯¼å‡ºå›¾ç‰‡æŒ‰é’®
            exportImageBtn.addEventListener('click', showExportModal);
            
            // å›¾ç‰‡å¯¼å‡ºæ¨¡æ€æ¡†äº‹ä»¶
            closeExportBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });
            
            downloadImageBtn.addEventListener('click', downloadImage);
            
            // æ·»åŠ åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡äº‹ä»¶
            openInNewTabBtn.addEventListener('click', openImageInNewTab);
            
            cancelExportBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­å›¾ç‰‡å¯¼å‡ºæ¨¡æ€æ¡†
            exportModal.addEventListener('click', (e) => {
                if (e.target === exportModal) {
                    exportModal.style.display = 'none';
                }
            });
        }

        // APIåŸºç¡€URL
        const API_BASE_URL = '/api';

        // è·å–ä¸€å¹´ä¸­çš„å‘¨æ•°
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // åœ¨canvasä¸Šç»˜åˆ¶æ’æœŸè¡¨ï¼ˆæ‰€è§å³æ‰€å¾—ç‰ˆæœ¬ï¼‰
        function drawScheduleToCanvas() {
            // åˆ›å»ºä¸´æ—¶çš„DOMå…ƒç´ ç”¨äºæ¸²æŸ“
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '-9999px';
            tempContainer.style.width = '1200px';
            tempContainer.style.backgroundColor = '#f5f5f5';
            tempContainer.style.padding = '20px';
            
            // åˆ›å»ºå¤´éƒ¨ï¼ˆä¸åŒ…å«"æ’æœŸé€šå‘Šå·¥å…·"æ ‡é¢˜ï¼‰
            const header = document.createElement('div');
            header.style.backgroundColor = 'white';
            header.style.borderRadius = '8px';
            header.style.padding = '20px';
            header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
            header.style.marginBottom = '20px';
            header.style.textAlign = 'center';
            
            // åˆ›å»ºå‘¨ä¿¡æ¯ï¼ˆä¸åŒ…å«æ ‡é¢˜ï¼‰
            const weekDates = getWeekDates(currentMonday);
            const weekNumber = getWeekNumber(weekDates[0]);
            const year = weekDates[0].getFullYear();
            const startDate = formatMonthDay(weekDates[0]);
            const endDate = formatMonthDay(weekDates[6]);
            
            const weekInfo = document.createElement('div');
            weekInfo.textContent = `${year}å¹´ç¬¬${weekNumber}å‘¨ å‘¨é€šå‘Š (${startDate} - ${endDate})`;
            weekInfo.style.fontWeight = 'bold';
            weekInfo.style.fontSize = '18px';
            weekInfo.style.color = '#7f8c8d';
            
            header.appendChild(weekInfo);
            
            // åˆ›å»ºä¸»è¦å†…å®¹åŒºåŸŸ
            const mainContent = document.createElement('div');
            mainContent.style.backgroundColor = 'white';
            mainContent.style.borderRadius = '8px';
            mainContent.style.overflow = 'hidden';
            mainContent.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
            
            // åˆ›å»ºæ˜ŸæœŸæ ‡é¢˜
            const weekHeader = document.createElement('div');
            weekHeader.style.display = 'grid';
            weekHeader.style.gridTemplateColumns = 'repeat(7, 1fr)';
            weekHeader.style.backgroundColor = '#3498db';
            weekHeader.style.color = 'white';
            
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            for (let i = 0; i < 7; i++) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.style.padding = '15px';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontWeight = 'bold';
                
                const date = weekDates[i];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                dayHeader.textContent = `${weekdays[i]}\n(${month}/${day})`;
                
                weekHeader.appendChild(dayHeader);
            }
            
            // åˆ›å»ºæ’æœŸå®¹å™¨
            const scheduleContainer = document.createElement('div');
            scheduleContainer.style.display = 'grid';
            scheduleContainer.style.gridTemplateColumns = 'repeat(7, 1fr)';
            scheduleContainer.style.minHeight = '500px';
            
            // åˆ›å»ºæ¯å¤©çš„åˆ—
            for (let i = 0; i < 7; i++) {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.style.borderRight = '1px solid #eee';
                dayColumn.style.padding = '15px';
                dayColumn.style.minHeight = '500px';
                
                if (i === 6) {
                    dayColumn.style.borderRight = 'none';
                }
                
                const dateStr = formatDate(weekDates[i]);
                const projects = scheduleData[dateStr] || [];
                
                if (projects.length > 0) {
                    projects.forEach((project, projectIndex) => {
                        // åˆ›å»ºé¡¹ç›®å¡ç‰‡
                        const projectCard = createProjectCard(project, dateStr, projectIndex);
                        dayColumn.appendChild(projectCard);
                    });
                } else {
                    // æ˜¾ç¤ºç©ºçŠ¶æ€
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.style.color = '#95a5a6';
                    emptyState.style.textAlign = 'center';
                    emptyState.style.padding = '20px';
                    emptyState.style.fontSize = '24px';
                    emptyState.textContent = 'ğŸˆšï¸';
                    dayColumn.appendChild(emptyState);
                }
                
                scheduleContainer.appendChild(dayColumn);
            }
            
            mainContent.appendChild(weekHeader);
            mainContent.appendChild(scheduleContainer);
            
            tempContainer.appendChild(header);
            tempContainer.appendChild(mainContent);
            
            // æ·»åŠ åˆ°æ–‡æ¡£ä¸­
            document.body.appendChild(tempContainer);
            
            // ä½¿ç”¨html2canvasåº“å°†DOMå…ƒç´ æ¸²æŸ“åˆ°canvas
            html2canvas(tempContainer, {
                scale: 2, // æé«˜åˆ†è¾¨ç‡
                useCORS: true,
                backgroundColor: '#f5f5f5'
            }).then(canvas => {
                // å°†ç”Ÿæˆçš„canvasæ›¿æ¢åˆ°å¯¼å‡ºcanvasä¸­
                const exportCtx = exportCanvas.getContext('2d');
                exportCanvas.width = canvas.width;
                exportCanvas.height = canvas.height;
                exportCtx.drawImage(canvas, 0, 0);
                
                // ç§»é™¤ä¸´æ—¶å…ƒç´ 
                document.body.removeChild(tempContainer);
            }).catch(error => {
                console.error('å¯¼å‡ºå›¾ç‰‡æ—¶å‡ºé”™:', error);
                // ç§»é™¤ä¸´æ—¶å…ƒç´ 
                document.body.removeChild(tempContainer);
                
                // å‡ºé”™æ—¶æ˜¾ç¤ºæç¤º
                alert('å¯¼å‡ºå›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
            });
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            const canvas = exportCanvas;
            const link = document.createElement('a');
            link.download = 'ç½å¤´åœºé€šå‘Šæ’æœŸ.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // ç§»åŠ¨ç«¯ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ
        // å·²ç§»é™¤æ­¤åŠŸèƒ½

        // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡
        function openImageInNewTab() {
            const canvas = exportCanvas;
            try {
                // å°†canvasè½¬æ¢ä¸ºæ•°æ®URLå¹¶åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                const dataURL = canvas.toDataURL('image/png');
                const newWindow = window.open();
                newWindow.document.write(`<img src="${dataURL}" alt="ç½å¤´åœºé€šå‘Šæ’æœŸ" style="width:100%;height:auto;" />`);
                newWindow.document.close();
            } catch (error) {
                console.error('åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡æ—¶å‡ºé”™:', error);
                alert('æ— æ³•åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾ç‰‡ï¼Œè¯·å°è¯•ä¸‹è½½å›¾ç‰‡');
            }
        }

        // æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
        function showExportModal() {
            exportModal.style.display = 'block';
            drawScheduleToCanvas();
        }

        // æ’æœŸç›¸å…³API
        const scheduleAPI = {
            // è·å–æ’æœŸæ•°æ®
            getSchedules: async (params = {}) => {
                const queryParams = new URLSearchParams(params).toString();
                const url = `/schedules${queryParams ? `?${queryParams}` : ''}`;
                
                const response = await apiRequest(url);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'è·å–æ’æœŸæ•°æ®å¤±è´¥');
                }
                
                return response.json();
            }
        };

        // æ˜¾ç¤ºå®æ—¶æ›´æ–°æç¤º
        function showRealtimeIndicator() {
            const indicator = document.getElementById('realtime-indicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // è¿æ¥SSEå®ç°å®æ—¶åŒæ­¥
        function connectSSE() {
            const eventSource = new EventSource('/events');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                switch (data.type) {
                    case 'scheduleUpdate':
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        scheduleData[data.date] = data.projects;
                        // é‡æ–°æ¸²æŸ“å½“å‰å‘¨çš„è§†å›¾
                        renderSchedule();
                        // æ˜¾ç¤ºå®æ—¶æ›´æ–°æç¤º
                        showRealtimeIndicator();
                        break;
                    case 'scheduleDelete':
                        // ä»æœ¬åœ°æ•°æ®ä¸­åˆ é™¤
                        delete scheduleData[data.date];
                        // é‡æ–°æ¸²æŸ“å½“å‰å‘¨çš„è§†å›¾
                        renderSchedule();
                        // æ˜¾ç¤ºå®æ—¶æ›´æ–°æç¤º
                        showRealtimeIndicator();
                        break;
                }
            };
            
            eventSource.onerror = function(err) {
                console.error('SSEè¿æ¥é”™è¯¯:', err);
            };
        }

        // ä»APIåŠ è½½æ’æœŸæ•°æ®
        async function loadScheduleData() {
            try {
                // ä»APIè·å–æ‰€æœ‰æ•°æ®ï¼ˆä¸ä¼ é€’æ—¥æœŸèŒƒå›´å‚æ•°ï¼‰
                scheduleData = await scheduleAPI.getSchedules();
                
                renderSchedule();
            } catch (error) {
                console.error('åŠ è½½æ’æœŸæ•°æ®æ—¶å‡ºé”™:', error);
                // ä½¿ç”¨ç©ºå¯¹è±¡ä½œä¸ºé»˜è®¤å€¼
                scheduleData = {};
                renderSchedule();
            }
        }

        // åˆå§‹åŒ–é¢„è§ˆé¡µé¢
        async function initPreview() {
            updateWeekDisplay();
            setupEventListeners();
            
            // ä»APIåŠ è½½æ•°æ®
            await loadScheduleData();
            
            // è¿æ¥SSEå®ç°å®æ—¶åŒæ­¥
            connectSSE();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é¢„è§ˆ
        document.addEventListener('DOMContentLoaded', initPreview);
    </script>
</body>
</html>